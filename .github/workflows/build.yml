name: Build Input Leap for Raspberry Pi

# Trigger the workflow on a push to any branch
on:
  push:
    branches:
      - '**'  # This will trigger the workflow on any branch

  # Optional: You can also add PR event if you want to trigger it for PRs
  pull_request:
    branches:
      - '**'

  # If you still want manual triggering, keep the workflow_dispatch as well
  workflow_dispatch:
    inputs:
      version:
        description: 'Which version to build'
        required: true
        default: 'latest'
      architecture:
        description: 'Which architecture to target (e.g., arm, arm64)'
        required: true
        default: 'arm64'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgl1-mesa-dev \
          libx11-dev \
          libxext-dev \
          libxrender-dev \
          libssl-dev \
          libavahi-compat-libdnssd-dev \
          qtbase5-dev \
          qtchooser \
          qt6-base-dev \
          g++-arm-linux-gnueabihf \
          gcc-arm-linux-gnueabihf \
          libtool \
          pkg-config \
          python3 \
          clang \
          llvm \
          libclang-dev

    - name: Set CMake compiler to GCC
      run: |
        export CC=gcc
        export CXX=g++

    - name: Download Qt6 source
      run: |
        mkdir -p $HOME/qt6
        cd $HOME/qt6
        git clone --branch 6.5 https://code.qt.io/qt/qt5.git qt6
        cd qt6
        git submodule update --init --recursive

    - name: Create tmp directory with more space
      run: |
        mkdir -p $HOME/tmp
        export TMPDIR=$HOME/tmp

    - name: Build Qt6 from source
      run: |
        cd $HOME/qt6/qt6
        mkdir build
        cd build
        cmake -DCMAKE_INSTALL_PREFIX=$HOME/qt6-install \
              -DCMAKE_BUILD_TYPE=Release \
              -Wno-dev -G "Unix Makefiles" ..
        make -j2
        make install

    - name: Create build directory
      run: mkdir build

    - name: Run CMake with Qt6
      run: |
        cd build
        cmake -DCMAKE_TOOLCHAIN_FILE=../toolchain-arm64.cmake \
              -DCMAKE_PREFIX_PATH=$HOME/qt6-install/lib/cmake/Qt6 ..

    - name: Build Input Leap for Raspberry Pi
      run: |
        cd build
        make -j2  # Reduce parallel jobs if necessary

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-output
        path: ./output/